// Add this function to lib.php after meetingsattendance_check_completion()

/**
 * Fetch and synchronize attendance data from platform
 *
 * Main entry point for attendance synchronization. Fetches data from
 * Teams or Zoom API based on session configuration and matches
 * participants to Moodle users via exact email matching.
 *
 * @param int $cmid Course module ID
 * @return array Synchronization statistics
 * @throws moodle_exception If sync fails
 */
function meetingsattendance_fetch_and_sync_attendance($cmid) {
    global $DB;

    try {
        // Get course module and context
        list($course, $cm) = get_course_and_cm_from_cmid($cmid, 'meetingsattendance');

        // Get session
        $session = $DB->get_record('meetingsattendance', array('id' => $cm->instance), '*', MUST_EXIST);

        if (!$session) {
            throw new moodle_exception('sessionnotfound', 'mod_meetingsattendance');
        }

        // Import sync class
        require_once(__DIR__ . '/classes/attendance_sync.php');
        $sync = new \mod_meetingsattendance\attendance_sync($session, $cm);

        // Extract datetime filters if configured
        $start_datetime = $session->start_datetime ?? 0;
        $end_datetime = $session->end_datetime ?? 0;

        // Perform synchronization
        $stats = $sync->sync_attendance($start_datetime, $end_datetime);

        return $stats;

    } catch (Exception $e) {
        throw new moodle_exception('invaliddata', 'mod_meetingsattendance', '', $e->getMessage());
    }
}
